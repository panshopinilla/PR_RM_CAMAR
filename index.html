<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>AR · Tambo de Camar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">

    <style>
        :root {
            --naranja: #EB6242;
            --naranja-glow: rgba(235, 98, 66, 0.4);
            --dorado: #C8973A;
            --crema: #F5ECD7;
            --oscuro: #0A0806;
            --gris-suave: rgba(255,255,255,0.08);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--oscuro);
            font-family: 'Lato', sans-serif;
            overflow: hidden;
        }

        /* ── MODEL VIEWER ── */
        model-viewer {
            width: 100%; height: 100%;
            --poster-color: transparent;
            background-color: transparent;
        }

        /* ── PANTALLA DE INSTRUCCIONES ── */
        #pantalla-inicio {
            position: fixed; inset: 0;
            background: var(--oscuro);
            display: flex; flex-direction: column;
            justify-content: flex-end; align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        #pantalla-inicio.oculto {
            opacity: 0;
            transform: scale(1.04);
            pointer-events: none;
        }

        /* Imagen de instrucciones - ocupa todo el fondo */
        #pantalla-inicio .bg-imagen {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0.92;
        }

        /* Gradiente para que el botón sea legible */
        #pantalla-inicio::after {
            content: '';
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 35%;
            background: linear-gradient(to top, var(--oscuro) 30%, transparent);
            pointer-events: none;
        }

        /* ── BOTÓN PRINCIPAL ── */
        #boton-activar-ar {
            position: relative; z-index: 10;
            margin-bottom: 48px;
            background: var(--naranja);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 18px 44px;
            font-family: 'Cinzel', serif;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 0 0 0 var(--naranja-glow);
            animation: pulso 2.4s ease-in-out infinite;
            transition: transform 0.15s, box-shadow 0.15s;
            display: flex; align-items: center; gap: 12px;
            white-space: nowrap;
        }

        #boton-activar-ar:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px var(--naranja-glow);
        }

        @keyframes pulso {
            0%, 100% { box-shadow: 0 0 0 0 var(--naranja-glow), 0 8px 30px var(--naranja-glow); }
            50%       { box-shadow: 0 0 0 14px transparent, 0 8px 30px var(--naranja-glow); }
        }

        /* Ícono de cámara animado */
        .icono-camara {
            width: 22px; height: 22px;
            position: relative; display: inline-block;
        }
        .icono-camara svg { width: 100%; height: 100%; fill: white; }

        /* ── OVERLAY AR (visible mientras el AR está activo) ── */
        #hud-ar {
            position: fixed; inset: 0;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #hud-ar.visible { opacity: 1; }

        /* Esquinas decorativas tipo visor */
        .esquina {
            position: absolute;
            width: 32px; height: 32px;
            border-color: var(--naranja);
            border-style: solid;
            opacity: 0.8;
        }
        .esquina.tl { top: 24px; left: 24px; border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
        .esquina.tr { top: 24px; right: 24px; border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
        .esquina.bl { bottom: 24px; left: 24px; border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }
        .esquina.br { bottom: 24px; right: 24px; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }

        /* Etiqueta nombre del sitio */
        #etiqueta-sitio {
            position: absolute; bottom: 36px; left: 50%;
            transform: translateX(-50%);
            font-family: 'Cinzel', serif;
            font-size: 12px;
            letter-spacing: 3px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* ── MENSAJE DE GUÍA (escaneo de superficie) ── */
        #mensaje-guia {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            padding: 0 32px;
        }

        #mensaje-guia.visible { opacity: 1; }

        .guia-anillo {
            width: 80px; height: 80px;
            border: 2px solid var(--dorado);
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            animation: girar 3s linear infinite;
        }

        .guia-anillo::before {
            content: '';
            position: absolute; top: -4px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 8px;
            background: var(--dorado);
            border-radius: 50%;
        }

        @keyframes girar { to { transform: rotate(360deg); } }

        .guia-texto {
            font-family: 'Lato', sans-serif;
            font-weight: 300;
            font-size: 14px;
            letter-spacing: 1.5px;
            color: rgba(255,255,255,0.85);
            line-height: 1.6;
        }

        /* ── BOTÓN CERRAR ── */
        #btn-cerrar {
            position: fixed; top: 24px; left: 20px;
            background: rgba(0,0,0,0.55);
            color: rgba(255,255,255,0.85);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 10px 18px;
            border-radius: 30px;
            font-family: 'Lato', sans-serif;
            font-size: 13px;
            letter-spacing: 1px;
            text-decoration: none;
            z-index: 200;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            cursor: pointer;
            transition: background 0.2s;
        }
        #btn-cerrar:active { background: rgba(0,0,0,0.8); }

        /* ── TOAST DE ERROR ── */
        #toast-error {
            position: fixed; bottom: 40px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(20,10,5,0.92);
            border: 1px solid var(--naranja);
            color: var(--crema);
            padding: 16px 24px;
            border-radius: 16px;
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            text-align: center;
            line-height: 1.5;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.4s, transform 0.4s;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }
        #toast-error.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ── CONTROLES AR DE AJUSTE FINO ── */
        #controles-ar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 70;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 16px 20px calc(env(safe-area-inset-bottom, 0px) + 20px);
            background: linear-gradient(to top, rgba(5,3,2,0.95) 60%, transparent);
            gap: 14px;
        }

        #controles-ar.visible { display: flex; }

        .ctrl-fila {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 340px;
        }

        .ctrl-label {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--dorado);
            text-transform: uppercase;
            width: 52px;
            text-align: right;
            flex-shrink: 0;
        }

        .ctrl-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 3px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            outline: none;
        }

        .ctrl-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: var(--naranja);
            box-shadow: 0 0 8px var(--naranja-glow);
            cursor: pointer;
        }

        .ctrl-valor {
            font-family: 'Lato', sans-serif;
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            width: 36px;
            text-align: left;
            flex-shrink: 0;
        }

        /* Botón reset */
        #btn-reset {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.6);
            padding: 8px 20px;
            border-radius: 20px;
            font-family: 'Lato', sans-serif;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            backdrop-filter: blur(6px);
        }

        /* ── LOADER DE MODELO ── */
        #loader-modelo {
            position: fixed; inset: 0;
            background: var(--oscuro);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #loader-modelo.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loader-bar-wrap {
            width: 180px; height: 2px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 24px;
        }
        .loader-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--dorado), var(--naranja));
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loader-titulo {
            font-family: 'Cinzel', serif;
            font-size: 13px;
            letter-spacing: 4px;
            color: var(--dorado);
            text-transform: uppercase;
            margin-top: 16px;
        }
    </style>
</head>
<body>

    <!-- BOTÓN CERRAR -->
    <a id="btn-cerrar" onclick="window.close(); history.back();">✕ Cerrar</a>

    <!-- LOADER DE MODELO -->
    <div id="loader-modelo">
        <div style="text-align:center">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" style="opacity:0.6">
                <rect x="4" y="20" width="40" height="3" rx="1.5" fill="#C8973A"/>
                <rect x="16" y="8" width="16" height="3" rx="1.5" fill="#C8973A"/>
                <rect x="16" y="37" width="16" height="3" rx="1.5" fill="#C8973A"/>
                <rect x="4" y="8" width="8" height="8" rx="1" fill="#EB6242"/>
                <rect x="36" y="8" width="8" height="8" rx="1" fill="#EB6242"/>
                <rect x="4" y="32" width="8" height="8" rx="1" fill="#EB6242"/>
                <rect x="36" y="32" width="8" height="8" rx="1" fill="#EB6242"/>
            </svg>
        </div>
        <div class="loader-titulo">Cargando modelo</div>
        <div class="loader-bar-wrap">
            <div class="loader-bar-fill" id="barra-progreso"></div>
        </div>
    </div>

    <!-- MODEL VIEWER -->
    <model-viewer
        id="visor-ar"
        src="./assets/models/montado_general_optimizado_Optimizado-1.glb"
        alt="Maqueta Tambo de Camar"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        interaction-prompt="none"
        ar-placement="floor"
        ar-scale="fixed"
        scale="0.034 0.034 0.034"
        shadow-intensity="1.2"
        shadow-softness="0.8"
        environment-image="neutral"
        exposure="1.1">

        <!-- Botón AR nativo del sistema (requerido por model-viewer, oculto visualmente) -->
        <button slot="ar-button" id="ar-button-nativo" style="display:none;"></button>

    </model-viewer>

    <!-- PANTALLA DE INSTRUCCIONES -->
    <div id="pantalla-inicio">
        <img src="./assets/instrucciones.png" alt="Instrucciones AR" class="bg-imagen">
        <button id="boton-activar-ar">
            <span class="icono-camara">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 15.2A3.2 3.2 0 1 0 12 8.8a3.2 3.2 0 0 0 0 6.4zm7-12H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V6.2A3 3 0 0 0 19 3.2zm-7 13a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
                </svg>
            </span>
            ACTIVAR CÁMARA AR
        </button>
    </div>

    <!-- HUD mientras AR activo -->
    <div id="hud-ar">
        <div class="esquina tl"></div>
        <div class="esquina tr"></div>
        <div class="esquina bl"></div>
        <div class="esquina br"></div>
        <div id="etiqueta-sitio">Tambo de Camar · Experiencia AR</div>
    </div>

    <!-- CONTROLES DE AJUSTE AR -->
    <div id="controles-ar">
        <div class="ctrl-fila">
            <span class="ctrl-label">Escala</span>
            <input type="range" class="ctrl-slider" id="slider-escala"
                min="0.005" max="0.12" step="0.001" value="0.034">
            <span class="ctrl-valor" id="val-escala">3.4cm</span>
        </div>
        <div class="ctrl-fila">
            <span class="ctrl-label">Rotar</span>
            <input type="range" class="ctrl-slider" id="slider-rotacion"
                min="0" max="360" step="1" value="0">
            <span class="ctrl-valor" id="val-rotacion">0°</span>
        </div>
        <button id="btn-reset">↺ Reset</button>
    </div>

    <!-- Mensaje guía de escaneo -->
    <div id="mensaje-guia">
        <div class="guia-anillo"></div>
        <p class="guia-texto">Mueve la cámara lentamente<br>sobre la maqueta</p>
    </div>

    <!-- Toast de error -->
    <div id="toast-error" id="toast">
        ⚠️ Tu dispositivo no soporta AR.<br>
        <span style="font-size:12px; opacity:0.7;">Prueba desde Safari en iOS o Chrome en Android.</span>
    </div>

    <script>
        const viewer        = document.getElementById('visor-ar');
        const pantallaInicio = document.getElementById('pantalla-inicio');
        const boton         = document.getElementById('boton-activar-ar');
        const arButtonNativo = document.getElementById('ar-button-nativo');
        const hudAr         = document.getElementById('hud-ar');
        const mensajeGuia   = document.getElementById('mensaje-guia');
        const toastError    = document.getElementById('toast-error');
        const loaderModelo  = document.getElementById('loader-modelo');
        const barraProgreso = document.getElementById('barra-progreso');

        // ── Mostrar loader mientras carga el modelo ──
        loaderModelo.classList.add('visible');

        // Función central para ocultar el loader
        function ocultarLoader() {
            loaderModelo.style.transition = 'opacity 0.6s ease';
            loaderModelo.style.opacity = '0';
            setTimeout(() => {
                loaderModelo.classList.remove('visible');
                loaderModelo.style.opacity = '';
            }, 600);
        }

        // TIMEOUT DE SEGURIDAD: si en 15s no cargó, ocultar igual
        const timeoutLoader = setTimeout(() => {
            console.warn('Timeout: ocultando loader por seguridad');
            ocultarLoader();
        }, 15000);

        viewer.addEventListener('progress', (e) => {
            const pct = Math.round(e.detail.totalProgress * 100);
            barraProgreso.style.width = pct + '%';
        });

        viewer.addEventListener('load', () => {
            clearTimeout(timeoutLoader);
            setTimeout(ocultarLoader, 300);

            if (!viewer.canActivateAR) {
                mostrarToast();
                boton.style.opacity = '0.4';
                boton.style.pointerEvents = 'none';
                boton.textContent = '⚠️ AR no disponible';
            }
        });

        // ERROR al cargar modelo (ruta incorrecta, archivo muy grande, etc.)
        viewer.addEventListener('error', (e) => {
            clearTimeout(timeoutLoader);
            console.error('Error cargando modelo:', e);
            const titulo = document.querySelector('.loader-titulo');
            if (titulo) { titulo.textContent = '⚠️ Error al cargar modelo'; titulo.style.color = '#EB6242'; }
            setTimeout(ocultarLoader, 2000);
        });

        // ── Click en botón principal ──
        boton.addEventListener('click', () => {
            if (!viewer.canActivateAR) {
                mostrarToast();
                return;
            }

            // 1. Ocultar pantalla de instrucciones con animación
            pantallaInicio.classList.add('oculto');

            // 2. Mostrar guía de escaneo
            setTimeout(() => {
                mensajeGuia.classList.add('visible');

                // 3. Disparar AR nativo del sistema
                arButtonNativo.click();

                // 4. Ocultar guía después de 4s
                setTimeout(() => mensajeGuia.classList.remove('visible'), 4500);

            }, 400);
        });

        // ── Eventos del ciclo AR ──
        viewer.addEventListener('ar-status', (e) => {
            const estado = e.detail.status;

            if (estado === 'session-started') {
                hudAr.classList.add('visible');
                mensajeGuia.classList.add('visible');
                controlesAr.classList.add('visible');  // mostrar controles
            }

            if (estado === 'object-placed') {
                mensajeGuia.classList.remove('visible');
            }

            if (estado === 'failed') {
                mostrarToast();
                hudAr.classList.remove('visible');
                mensajeGuia.classList.remove('visible');
                // Restaurar pantalla inicio si el AR falla
                pantallaInicio.classList.remove('oculto');
            }
        });

        viewer.addEventListener('ar-tracking', (e) => {
            // Si el tracking se pierde, mostrar guía de re-escaneo
            if (e.detail.status === 'not-tracking') {
                mensajeGuia.classList.add('visible');
                mensajeGuia.querySelector('.guia-texto').textContent = 
                    'Apunta la cámara\na la maqueta de nuevo';
            } else if (e.detail.status === 'tracking') {
                mensajeGuia.classList.remove('visible');
            }
        });

        viewer.addEventListener('ar-status', (e) => {
            if (e.detail.status === 'not-presenting') {
                hudAr.classList.remove('visible');
                mensajeGuia.classList.remove('visible');
                controlesAr.classList.remove('visible');  // ocultar controles
                pantallaInicio.classList.remove('oculto');
            }
        });

        // ── CONTROLES DE AJUSTE FINO ──
        const controlesAr   = document.getElementById('controles-ar');
        const sliderEscala  = document.getElementById('slider-escala');
        const sliderRot     = document.getElementById('slider-rotacion');
        const valEscala     = document.getElementById('val-escala');
        const valRotacion   = document.getElementById('val-rotacion');
        const btnReset      = document.getElementById('btn-reset');

        // Escala inicial calculada para 34cm (modelo en metros reales)
        const ESCALA_BASE = 0.034;
        let escalaActual = ESCALA_BASE;
        let rotacionActual = 0;

        function aplicarTransformacion() {
            const s = escalaActual;
            const r = rotacionActual;
            viewer.setAttribute('scale', `${s} ${s} ${s}`);
            viewer.setAttribute('orientation', `0deg ${r}deg 0deg`);
        }

        sliderEscala.addEventListener('input', () => {
            escalaActual = parseFloat(sliderEscala.value);
            const cm = (escalaActual * 100).toFixed(1);
            valEscala.textContent = cm + 'cm';
            aplicarTransformacion();
        });

        sliderRot.addEventListener('input', () => {
            rotacionActual = parseInt(sliderRot.value);
            valRotacion.textContent = rotacionActual + '°';
            aplicarTransformacion();
        });

        btnReset.addEventListener('click', () => {
            escalaActual = ESCALA_BASE;
            rotacionActual = 0;
            sliderEscala.value = ESCALA_BASE;
            sliderRot.value = 0;
            valEscala.textContent = '3.4cm';
            valRotacion.textContent = '0°';
            aplicarTransformacion();
        });

        // ── Toast de error ──
        function mostrarToast() {
            toastError.classList.add('visible');
            setTimeout(() => toastError.classList.remove('visible'), 4000);
        }
    </script>
</body>
</html>